---
title: "Data Cleanse-Assortment Optimization"
output: word_document
---
 
Specify that NA in the feature display = 0.  
 
Install packages.

```{r eval=FALSE, include=FALSE}
install.packages("tidyverse")
install.packages("tibbletime")
install.packages("lubridate")
install.packages("tsoutliers")
install.packages("forecast")
install.packages("rmarkdown")
install.packages("purrr")
install.packages("plyr")
install.packages("cowplot")
```


Load library and increase memory limit.

```{r}
library(cowplot)
library(plyr)
library(tibbletime)
library(lubridate)
library(tsoutliers)
library(forecast)
library(tidyverse)
library(httr)
library(jsonlite)
library(stringr)
library(tidytext)
memory.limit(size = 50000)
```


Unzip file.

try reading in all upcs as strings

```{r}
untar("C:/Users/marke/Downloads/peanutbutter.tgz", list = TRUE)

untar("C:/Users/marke/Downloads/peanutbutter.tgz")

move_11 <- read_tsv("nielsen_extracts/RMS/2011/Movement_Files/0506_2011/1421_2011.tsv", col_types = "dddddddd")

stores_11 <- read_tsv("nielsen_extracts/RMS/2011/Annual_Files/stores_2011.tsv", col_types = "ddddccdcdcdc")

move_12 <- read_tsv("nielsen_extracts/RMS/2012/Movement_Files/0506_2012/1421_2012.tsv", col_types = "dddddddd")

stores_12 <- read_tsv("nielsen_extracts/RMS/2012/Annual_Files/stores_2012.tsv",col_types = "ddddccdcdcdc")

move_13 <- read_tsv("nielsen_extracts/RMS/2013/Movement_Files/0506_2013/1421_2013.tsv", col_types = "dddddddd")

stores_13 <- read_tsv("nielsen_extracts/RMS/2013/Annual_Files/stores_2013.tsv", col_types = list(col_double(), col_double(),
                        col_double(), col_double(), col_character(), col_character(), col_double(), col_character(), col_double(),
                        col_character(), col_double(), col_character()))

products <- read_tsv("nielsen_extracts/RMS/Master_Files/Latest/products.tsv", quote = "", col_types = "ddcdcdcdcdcdddccd")
```


  Merge the data from the 'stores' file and the 'products' master file to the movement file for each year. Filter for channel code 'F', which denotes 'Food' and 
for the 4 states where supervalue operates (North Dakota, Minnesota, Missouri, and D.C.).

```{r}
full_11 <- move_11 %>%
  inner_join(stores_11, by ="store_code_uc") %>% 
  filter(channel_code == "F" & fips_state_descr %in% c("ND", "MN", "MO" ,"DC")) %>%
  inner_join(products, by ="upc")

full_12 <- move_12 %>%
  inner_join(stores_12, by ="store_code_uc") %>% 
  filter(channel_code == "F" & fips_state_descr %in% c("ND", "MN", "MO" ,"DC")) %>%
  inner_join(products, by ="upc")

full_13 <- move_13 %>%
  inner_join(stores_13, by ="store_code_uc") %>% 
  filter(channel_code == "F" & fips_state_descr %in% c("ND", "MN", "MO" ,"DC")) %>%
  inner_join(products, by ="upc")
```


Combine 'full_11', 'full_12', and 'full_13' into one file, 'full_11_12_13' containing the data for all years.
Change 'week_end' variable to year-month-day format. Create variable 'sales' which is 'units' * 'price'.

```{r}
full_11_12_13 <- full_11 %>%
  bind_rows(full_12) %>%
  bind_rows(full_13) %>%
  mutate(week_end = ymd(week_end), sales = units * price)
```


Create tbls containing each distinct store code ('store_id_11/12/13'). Anti join those tbls to get 6 more tbls containing just the stores that 
only show up in 1 of the years ex: 'in_11_not_12'. Anti join those tbls with the full movement file to remove the stores that only appear in 1
of the years. Create a new variable 'manuf_name' which contains the first 3 characters of the brand_name and allows for easy identification of the 
manufacturers. Save the full movement file and remove unneccesary files from memory.

```{r}
store_id_11 <- distinct(full_11, store_code_uc)
store_id_12 <- distinct(full_12, store_code_uc)
store_id_13 <- distinct(full_13, store_code_uc)

in_11_not_12 <- anti_join(store_id_11, store_id_12, by = "store_code_uc")
in_11_not_13 <- anti_join(store_id_11, store_id_13, by = "store_code_uc")
in_12_not_11 <- anti_join(store_id_12, store_id_11, by = "store_code_uc")
in_12_not_13 <- anti_join(store_id_12, store_id_13, by = "store_code_uc")
in_13_not_11 <- anti_join(store_id_13, store_id_11, by = "store_code_uc")
in_13_not_12 <- anti_join(store_id_13, store_id_12, by = "store_code_uc")

full_11_12_13 <- full_11_12_13 %>%
  anti_join(in_11_not_12, by = "store_code_uc") %>%
  anti_join(in_11_not_13, by = "store_code_uc") %>%
  anti_join(in_12_not_11, by = "store_code_uc") %>%
  anti_join(in_12_not_13, by = "store_code_uc") %>%
  anti_join(in_13_not_11, by = "store_code_uc") %>%
  anti_join(in_13_not_12, by = "store_code_uc")

full_11_12_13 <- full_11_12_13 %>%
  mutate(manuf_name = substr(full_11_12_13$brand_descr, 1, 3))

save(full_11_12_13, file = "full_11_12_13.RData")

rm(full_11, full_12, full_13, in_11_not_12, in_11_not_13, in_12_not_11, in_12_not_13, in_13_not_11, in_13_not_12,
   store_id_11, store_id_12, store_id_13, move_11, move_12, move_13, products, stores_11, stores_12, stores_13)
```


Create vector 'stores' that contains each distinct store in the full movement file. Define a vector 'retail_switchers' that will contain the codes
for every store that switches retail codes between 2011, 2012, or 2013. The 'for' loop finds these codes and stores them in 'retail_switchers'.

```{r}
stores <- unique(full_11_12_13$store_code_uc)

retail_switchers <- vector("numeric", length = 0)

for (i in seq_along(stores)) {
  
  ind_store_sales <- full_11_12_13 %>%
    filter(store_code_uc == stores[i])
  
  switcher_test <- unique(ind_store_sales$retailer_code)
  
  if (length(switcher_test) > 1) {
    
    retail_switchers <- append(retail_switchers, stores[i])
    
  }
}
```


Define a vector 'parent_switchers' that will contain the codes for every store that switches parent codes between 2011, 2012, or 2013. The 'for' loop
finds these codes and stores them in 'parent_switchers'.

```{r}
parent_switchers <- vector("numeric", length = 0)

for (i in seq_along(stores)) {
  
  ind_store_sales <- full_11_12_13 %>%
    filter(store_code_uc == stores[i])
  
  switcher_test <- unique(ind_store_sales$parent_code)
  
  if (length(switcher_test) > 1) {
    
    parent_switchers <- append(parent_switchers, stores[i])
    
  }
}
```


Print 'retail_switchers' and 'parent_switchers'.

```{r}
retail_switchers

parent_switchers
```


Create tbl 'switchers' that contains the data for every store that switches retail or parent codes. Filter out these stores from the full movement
file.

```{r}
switchers <- full_11_12_13 %>%
  filter(store_code_uc %in% retail_switchers | store_code_uc %in% parent_switchers)

full_11_12_13 <- full_11_12_13 %>%
  anti_join(switchers, by = "store_code_uc")
```

Create a summary variable of average price for each upc in each individual store. Join this with the full dataset. 

```{r}
avgprice <- full_11_12_13 %>% 
  group_by(upc,store_code_uc)%>% 
  summarize(avgprice = mean(price)) %>% 
  ungroup()

full_11_12_13 <- full_11_12_13 %>% left_join(avgprice)
```
Perform string search within brand & upc descr to identify differentiating factors across products. Also format dataset to match any additional information.  

## ACV is commodity volume information. 

```{r}
# Add necessary columns to fit data. Volume converted to ounces. 
week <- as.data.frame(sort(unique(full_11_12_13$week_end))) %>% cbind(1:157)
names(week) <- c("week_end", "week")

full_11_12_13 <- full_11_12_13 %>% inner_join(week)

full_11_12_13 <- full_11_12_13 %>% mutate(volume = ifelse(size1_units == "PO", size1_amount * units * 16, units * size1_amount), 
                      price.vol = volume/units)


```


Find unique terms. Add the features explained from UPC_Descr as unique column attribute to finished dataset. 
```{r}
name <- unique(full_11_12_13$upc_descr) 
row_number <- 1:257
upcs <- cbind(row_number,name)

upcs <- as_tibble(upcs)
upcs <- data.frame(upcs, stringsAsFactors = FALSE)
upcs <- upcs %>% unnest_tokens(words,name)
upcs %>% 
  count(words, sort = TRUE)

uniterms <- unique(upcs$words)

reducedf <- c("R-F","rf")
lowsod <- c("l-s","lsd")
honey <- c("hny", "t-b-kns")
powder <- c("powder","pwd")
chocolate <- c("CHOC","COCOA", "chc")
packed <- c("2p","3p","6p","8p","10p")
spread <- c("sp","spread")
hazeln <- c("hznl","hzlnt")
raspb <- c("rspby", "r-dz")



full_11_12_13 <- full_11_12_13 %>% mutate(
  reducedfat = if_else(str_detect(full_11_12_13$upc_descr, reducedf),1,0),
  lowsodium = if_else(str_detect(full_11_12_13$upc_descr, lowsod),1,0),
  extra = if_else(str_detect(full_11_12_13$upc_descr, "xtra"),1,0),
  organic = if_else(str_detect(full_11_12_13$upc_descr, "ORG"),1,0),
  squeeze = if_else(str_detect(full_11_12_13$upc_descr, "sqz"),1,0),
  organic = if_else(str_detect(full_11_12_13$upc_descr, "ORG"),1,0),
  nostir = if_else(str_detect(full_11_12_13$upc_descr, "no stir"),1,0),
  honey = if_else(str_detect(full_11_12_13$upc_descr, honey),1,0),
  hotpepper = if_else(str_detect(full_11_12_13$upc_descr, "hot pepper"),1,0),
  whipped = if_else(str_detect(full_11_12_13$upc_descr, "whipped"),1,0),
  canned = if_else(str_detect(full_11_12_13$upc_descr, "can"),1,0),
  powder = if_else(str_detect(full_11_12_13$upc_descr, powder),1,0),
  chunky = if_else(str_detect(full_11_12_13$upc_descr, "CHK"),1,0),
  creamy = if_else(str_detect(full_11_12_13$upc_descr, "crm"),1,0),
  pack = if_else(str_detect(full_11_12_13$upc_descr, packed),1,0),
  togo = if_else(str_detect(full_11_12_13$upc_descr, "to go"),1,0),
  spread = if_else(str_detect(full_11_12_13$upc_descr, spread),1,0),
  coconut = if_else(str_detect(full_11_12_13$upc_descr, "coconut"),1,0),
  fatfree = if_else(str_detect(full_11_12_13$upc_descr, "ff"),1,0),
  lowfat = if_else(str_detect(full_11_12_13$upc_descr, "low fat"),1,0),
  hazelnut = if_else(str_detect(full_11_12_13$upc_descr, hazeln),1,0),
  cinnamon = if_else(str_detect(full_11_12_13$upc_descr, " cn "),1,0),
  raisin = if_else(str_detect(full_11_12_13$upc_descr, "raisin"),1,0),
  hydrogenated = if_else(str_detect(full_11_12_13$upc_descr, " h "),1,0),
  nonhydrogenated = if_else(str_detect(full_11_12_13$upc_descr, " nh"),1,0),
  raspberry = if_else(str_detect(full_11_12_13$upc_descr,raspb),1,0),
  unsalted = if_else(str_detect(full_11_12_13$upc_descr, "uns"),1,0),
  whitechoc = if_else(str_detect(full_11_12_13$upc_descr, "white chocolate"),1,0),
  maple = if_else(str_detect(full_11_12_13$upc_descr, "maple"),1,0),
  darkchocolate = if_else(str_detect(full_11_12_13$upc_descr, "D-C"),1,0),
  reducedsodium = if_else(str_detect(full_11_12_13$upc_descr, " rs "),1,0),
  strawberry = if_else(str_detect(full_11_12_13$upc_descr, " sb "),1,0),
  lowsugar = if_else(str_detect(full_11_12_13$upc_descr, "lsg"),1,0),
  nosugar = if_else(str_detect(full_11_12_13$upc_descr, "nsg"),1,0),
  banana = if_else(str_detect(full_11_12_13$upc_descr, "bn"),1,0),
  butter = if_else(str_detect(full_11_12_13$upc_descr, "btr"),1,0),
  chocolate = if_else(str_detect(full_11_12_13$upc_descr, chocolate),1,0),
  blend = if_else(str_detect(full_11_12_13$upc_descr, "blnd"),1,0),
  lessfat = if_else(str_detect(full_11_12_13$upc_descr, "less fat"),1,0))                             
```

```{r}
names(full_11_12_13)
```
```{r}
#Create necessary data structure 
full_11_12_13 <- full_11_12_13[,c(3,2,21,4,6,38:41,32,36,7,8,42:79)]

rm(avgprice,ind_store_sales,switchers,volume,week)
```



